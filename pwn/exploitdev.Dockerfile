## Parameterized exploit-dev environment
## Tools: pwndbg, pwntools, gdb, build-essential
## Supports Ubuntu (20.04–24.04) and Debian (11–13) base images
ARG BASE_IMAGE=ubuntu24-base:latest
FROM ${BASE_IMAGE}
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# go back to root to simplify next few steps
USER root

ARG USERNAME=ubuntu
ARG BUILD_PYTHON310=false
ARG PEP668_WORKAROUND=false

# install dependencies: build deps, python3.10 deps, basic utils
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gdb \
    bear \
    tmux \
    file \
    procps \
    python3-dev \
    libffi-dev \
    zlib1g-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# compile python 3.10 from source (older distros lacking 3.10+ in repos)
ADD shared/build_python3.10.sh /opt/build_python3.10.sh
RUN if [ "$BUILD_PYTHON310" = "true" ]; then /opt/build_python3.10.sh; fi

# install pwndbg
RUN curl -qsLk 'https://install.pwndbg.re' -o /opt/pwndbg.sh \
    && chmod +x /opt/pwndbg.sh \
    && bash /opt/pwndbg.sh -t pwndbg-gdb

# allow pip install outside venv (PEP 668)
RUN if [ "$PEP668_WORKAROUND" = "true" ]; then \
    echo '[global]\nbreak-system-packages = true' > /etc/pip.conf; fi

# install pwntools
ADD ./shared/pwntools.sh /opt/pwntools.sh
RUN /opt/pwntools.sh

# clean up caches after install steps/scripts run
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

USER ${USERNAME}
VOLUME [ "/home/${USERNAME}/src" ]
WORKDIR /home/${USERNAME}/src

RUN echo 'export PATH=\"\$HOME/.local/bin:\$PATH\"' >> /home/${USERNAME}/.bashrc

ENTRYPOINT [ "/bin/bash" ]
